<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>会話中トントンリマインド</title>
<style>
  body { font-family: sans-serif; text-align: center; margin-top: 50px; }
  button { font-size: 20px; padding: 10px 20px; }
</style>
</head>
<body>
<h1>会話中トントンリマインド</h1>
<p>机をトントンして、会話が途切れたタイミングで音声リマインド！</p>
<button id="startBtn">センサー＆マイクを有効にする</button>

<audio id="remindAudio1" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
<audio id="remindAudio2" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"></audio>

<script>
const startBtn = document.getElementById('startBtn');
const audios = [
  document.getElementById('remindAudio1'),
  document.getElementById('remindAudio2')
];
let lastShake = 0;
let audioIndex = 0;

startBtn.addEventListener('click', async () => {
  // iOS 17以降のセンサー許可
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    const response = await DeviceMotionEvent.requestPermission();
    if (response !== 'granted') { alert('センサーの許可が必要です'); return; }
  }
  // マイクアクセス許可
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new AudioContext();
    const analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 512;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    // センサーイベント登録
    window.addEventListener('devicemotion', (event) => {
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;
      const totalAcc = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

      if (totalAcc > 15) {  // トントン判定
        const now = Date.now();
        if (now - lastShake > 2000) {  // 2秒以上空いたら
          // 周囲音量を取得
          analyser.getByteFrequencyData(dataArray);
          let avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
          if (avg < 10) { // 静かになったら反応
            lastShake = now;
            audios[audioIndex].play();
            audioIndex = (audioIndex + 1) % audios.length;
          }
        }
      }
    });

  } else {
    alert('マイクが使えません');
  }

  startBtn.disabled = true;
  startBtn.textContent = "実験中…";
});
</script>
</body>
</html>


